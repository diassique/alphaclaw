<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlphaClaw â€” Autopilot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/dashboard.css" />
</head>
<body>
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>

  <nav>
    <a class="logo" href="/">
      <div class="logo-icon"><img src="/logo.svg" alt="AlphaClaw" /></div>
      <div>AlphaClaw<div class="logo-sub">AI Alpha Marketplace</div></div>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="/">Dashboard</a>
      <a class="nav-link" href="/hunt-page">Hunt</a>
      <a class="nav-link" href="/autopilot-page">Autopilot</a>
      <a class="nav-link" href="/reputation-page">Reputation</a>
      <a class="nav-link" href="/memory-page">Memory</a>
      <a class="nav-link" href="/network-page">Network</a>
      <a class="nav-link" href="/reports-page">Reports</a>
      <a class="nav-link" href="/telegram-page">Telegram</a>
    </div>
    <div class="nav-right">
      <span class="tg-badge tg-off" id="tg-badge" title="Telegram Bot">TG OFF</span>
      <span class="badge badge-green"><span class="dot"></span> LIVE</span>
      <span class="badge badge-purple">Base Sepolia &middot; x402</span>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1><span>Autopilot</span> Control Center</h1>
      <p>Automated alpha hunting with adaptive intervals and topic rotation.</p>
    </div>

    <!-- Controls -->
    <div class="autopilot-panel">
      <div class="ap-controls">
        <button class="btn-sm btn-green" id="ap-start-btn" onclick="toggleAutopilot()">Start Autopilot</button>
        <div class="ap-status">
          <span class="ap-phase idle" id="ap-phase">IDLE</span>
          <span id="ap-hunt-count" style="color:var(--text3)">0 hunts</span>
        </div>
      </div>
      <div class="ap-meta" id="ap-meta">
        <div class="ap-meta-item"><div class="ap-meta-label">Interval</div><div class="ap-meta-val" id="ap-interval">5m 0s</div></div>
        <div class="ap-meta-item"><div class="ap-meta-label">Next Hunt</div><div class="ap-meta-val" id="ap-next">&mdash;</div></div>
        <div class="ap-meta-item"><div class="ap-meta-label">Last Confidence</div><div class="ap-meta-val" id="ap-confidence">&mdash;</div></div>
        <div class="ap-meta-item"><div class="ap-meta-label">Topic Index</div><div class="ap-meta-val" id="ap-topic">0</div></div>
        <div class="ap-meta-item"><div class="ap-meta-label">Hunt Count</div><div class="ap-meta-val" id="ap-count-val">0</div></div>
      </div>
    </div>

    <!-- Topic Rotation -->
    <div class="section-title">Topic Rotation</div>
    <div class="panel" id="topics-panel" style="margin-bottom:2rem;">
      <div id="topic-list" style="display:flex;flex-wrap:wrap;gap:.5rem;">
        <span style="color:var(--text3);font-size:.8rem;">Loading topics...</span>
      </div>
    </div>

    <!-- SSE Timeline -->
    <div class="section-title">Live Timeline</div>
    <div class="panel" style="margin-bottom:2rem;">
      <div class="ap-timeline" id="ap-timeline" style="max-height:500px;"></div>
      <div id="ap-timeline-empty" style="color:var(--text3);font-size:.8rem;text-align:center;padding:1rem;">Start autopilot to see live events</div>
    </div>

    <!-- Adaptation History -->
    <div class="section-title">Adaptation History</div>
    <div class="panel" style="margin-bottom:2rem;overflow-x:auto;">
      <table class="data-table" id="adapt-table">
        <thead><tr><th>Time</th><th>Old Interval</th><th>New Interval</th><th>Confidence</th><th>Reason</th></tr></thead>
        <tbody id="adapt-body"><tr><td colspan="5" style="text-align:center;color:var(--text3);">No adaptations yet</td></tr></tbody>
      </table>
    </div>
  </main>

  <!-- Status Strip -->
  <div class="status-strip" id="status-strip">
    <div class="status-strip-left">
      <div class="status-indicator loading" id="strip-indicator"></div>
      <span class="status-label loading" id="strip-label">Checking...</span>
    </div>
    <div class="status-dots" id="strip-dots"></div>
    <div class="status-meta">
      <span id="strip-latency">--</span> &middot; <span id="strip-checked">checking</span> &middot; <span class="status-countdown" id="strip-countdown"></span>
    </div>
  </div>

  <footer>
    <span>AlphaClaw Network &middot; Base Sepolia &middot; x402</span>
    <span>SURGE x OpenClaw Hackathon 2026</span>
  </footer>

  <script src="/dashboard.js"></script>
  <script>
    let autopilotRunning = false;
    let apSSE = null;
    let apTimelineItems = [];
    let adaptHistory = [];
    const defaultTopics = ['Trump impeachment','Fed rate cut March','Bitcoin ETF approval','Ethereum DeFi','Base L2 yields','Solana ecosystem','AI crypto tokens'];

    function updateApUI(status) {
      autopilotRunning = status.running;
      const btn = document.getElementById('ap-start-btn');
      btn.textContent = status.running ? 'Stop Autopilot' : 'Start Autopilot';
      btn.className = status.running ? 'btn-sm btn-red' : 'btn-sm btn-green';

      const phase = document.getElementById('ap-phase');
      phase.textContent = status.phase.toUpperCase();
      phase.className = `ap-phase ${status.phase}`;

      document.getElementById('ap-hunt-count').textContent = `${status.huntCount} hunts`;
      document.getElementById('ap-count-val').textContent = String(status.huntCount);
      document.getElementById('ap-interval').textContent = formatMs(status.currentIntervalMs);
      document.getElementById('ap-next').textContent = status.nextHuntAt ? new Date(status.nextHuntAt).toLocaleTimeString('en', {hour12:false}) : '\u2014';
      document.getElementById('ap-confidence').textContent = status.lastConfidence !== null ? `${status.lastConfidence.toFixed(1)}%` : '\u2014';
      document.getElementById('ap-topic').textContent = String(status.topicIndex);

      // Highlight current topic
      renderTopics(status.topicIndex);
    }

    function renderTopics(currentIdx) {
      document.getElementById('topic-list').innerHTML = defaultTopics.map((t, i) => {
        const active = i === currentIdx;
        return `<span class="topic-chip" style="${active ? 'border-color:var(--accent);color:var(--accent2);background:rgba(124,58,237,.1);' : ''}">${active ? '\u25b6 ' : ''}${t}</span>`;
      }).join('');
    }

    function addApTimeline(msg) {
      apTimelineItems.unshift(msg);
      if (apTimelineItems.length > 50) apTimelineItems.pop();
      document.getElementById('ap-timeline-empty').style.display = 'none';
      document.getElementById('ap-timeline').innerHTML = apTimelineItems.map(m =>
        `<div class="ap-timeline-item"><span>${m.text}</span><span style="color:var(--text3)">${m.time}</span></div>`
      ).join('');
    }

    function addAdaptation(data) {
      adaptHistory.unshift(data);
      if (adaptHistory.length > 50) adaptHistory.pop();
      document.getElementById('adapt-body').innerHTML = adaptHistory.map(a => `
        <tr>
          <td>${a.time}</td>
          <td>${a.oldInterval}</td>
          <td style="color:var(--accent2)">${a.newInterval}</td>
          <td>${a.confidence}</td>
          <td>${a.reason}</td>
        </tr>
      `).join('');
    }

    async function toggleAutopilot() {
      if (autopilotRunning) {
        await fetch('/autopilot/stop', { method: 'POST' });
        if (apSSE) { apSSE.close(); apSSE = null; }
        addApTimeline({ text: 'Autopilot stopped', time: new Date().toLocaleTimeString('en', {hour12:false}) });
      } else {
        await fetch('/autopilot/start', { method: 'POST' });
        connectAutopilotSSE();
        addApTimeline({ text: 'Autopilot started', time: new Date().toLocaleTimeString('en', {hour12:false}) });
      }
      const r = await fetch('/autopilot/status');
      updateApUI(await r.json());
    }

    function connectAutopilotSSE() {
      if (apSSE) apSSE.close();
      apSSE = new EventSource('/autopilot/stream');

      apSSE.addEventListener('status', e => updateApUI(JSON.parse(e.data)));
      apSSE.addEventListener('autopilot:phase', e => {
        const d = JSON.parse(e.data);
        const phase = document.getElementById('ap-phase');
        phase.textContent = d.phase.toUpperCase();
        phase.className = `ap-phase ${d.phase}`;
      });
      apSSE.addEventListener('autopilot:hunting', e => {
        const d = JSON.parse(e.data);
        addApTimeline({ text: `Hunting: ${d.topic}`, time: new Date().toLocaleTimeString('en', {hour12:false}) });
      });
      apSSE.addEventListener('autopilot:result', e => {
        const d = JSON.parse(e.data);
        addApTimeline({ text: `Result: ${d.confidence.toFixed(1)}% \u2014 ${d.recommendation.slice(0,50)}`, time: new Date().toLocaleTimeString('en', {hour12:false}) });
      });
      apSSE.addEventListener('autopilot:adapted', e => {
        const d = JSON.parse(e.data);
        const time = new Date().toLocaleTimeString('en', {hour12:false});
        addApTimeline({ text: `Adapted: ${formatMs(d.oldIntervalMs)} \u2192 ${formatMs(d.newIntervalMs)} (${d.reason})`, time });
        addAdaptation({ time, oldInterval: formatMs(d.oldIntervalMs), newInterval: formatMs(d.newIntervalMs), confidence: d.confidence ? d.confidence.toFixed(1) + '%' : '\u2014', reason: d.reason });
      });
      apSSE.addEventListener('autopilot:scheduled', e => {
        const d = JSON.parse(e.data);
        document.getElementById('ap-next').textContent = new Date(d.nextHuntAt).toLocaleTimeString('en', {hour12:false});
        document.getElementById('ap-interval').textContent = formatMs(d.intervalMs);
      });
      apSSE.addEventListener('autopilot:stopped', () => {
        autopilotRunning = false;
        const btn = document.getElementById('ap-start-btn');
        btn.textContent = 'Start Autopilot';
        btn.className = 'btn-sm btn-green';
        document.getElementById('ap-phase').textContent = 'IDLE';
        document.getElementById('ap-phase').className = 'ap-phase idle';
      });
      apSSE.onerror = () => {};
    }

    async function loadAutopilot() {
      try {
        const r = await fetch('/autopilot/status');
        const d = await r.json();
        updateApUI(d);
        if (d.running && !apSSE) connectAutopilotSSE();
      } catch {}
    }

    renderTopics(0);
    loadStatusStrip();
    loadTelegram();
    loadAutopilot();
  </script>
</body>
</html>
