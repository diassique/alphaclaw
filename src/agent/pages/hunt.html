<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlphaClaw â€” Hunt</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/dashboard.css" />
</head>
<body>
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>

  <nav>
    <a class="logo" href="/">
      <div class="logo-icon"><img src="/logo.svg" alt="AlphaClaw" /></div>
      <div>AlphaClaw<div class="logo-sub">AI Alpha Marketplace</div></div>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="/">Dashboard</a>
      <a class="nav-link" href="/hunt-page">Hunt</a>
      <a class="nav-link" href="/autopilot-page">Autopilot</a>
      <a class="nav-link" href="/reputation-page">Reputation</a>
      <a class="nav-link" href="/memory-page">Memory</a>
      <a class="nav-link" href="/network-page">Network</a>
      <a class="nav-link" href="/reports-page">Reports</a>
      <a class="nav-link" href="/telegram-page">Telegram</a>
    </div>
    <div class="nav-right">
      <span class="tg-badge tg-off" id="tg-badge" title="Telegram Bot">TG OFF</span>
      <span class="badge badge-green"><span class="dot"></span> LIVE</span>
      <span class="badge badge-purple">Base Sepolia &middot; x402</span>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1><span>Hunt</span> Alpha</h1>
      <p>Query all 5 data sources simultaneously, synthesize intelligence, and get actionable alpha.</p>
    </div>

    <!-- Hunt Form -->
    <div class="hunt-box" style="margin-bottom:2rem;">
      <div class="hunt-input-row">
        <input class="hunt-input" id="hunt-topic" type="text" placeholder="e.g. Trump impeachment 2026, Fed rate cut, Bitcoin ETF..." />
        <button class="btn btn-primary" id="hunt-btn" onclick="runHunt()">Hunt &rarr;</button>
      </div>
      <div class="quick-topics">
        <span class="topic-chip" onclick="setTopic(this)">Trump impeachment</span>
        <span class="topic-chip" onclick="setTopic(this)">Fed rate cut March</span>
        <span class="topic-chip" onclick="setTopic(this)">Bitcoin ETF approval</span>
        <span class="topic-chip" onclick="setTopic(this)">Ethereum DeFi</span>
        <span class="topic-chip" onclick="setTopic(this)">Base L2 yields</span>
        <span class="topic-chip" onclick="setTopic(this)">Solana ecosystem</span>
        <span class="topic-chip" onclick="setTopic(this)">AI crypto tokens</span>
      </div>
    </div>

    <!-- Dynamic Pricing -->
    <div class="section-title">Dynamic Pricing</div>
    <div class="panel" id="pricing-panel" style="margin-bottom:2rem;">
      <table class="data-table" id="pricing-table">
        <thead><tr><th>Service</th><th>Base Price</th><th>Effective Price</th><th>Multiplier</th><th>Reputation</th></tr></thead>
        <tbody id="pricing-body"><tr><td colspan="5" style="text-align:center;color:var(--text3);">Loading pricing...</td></tr></tbody>
      </table>
    </div>

    <!-- SSE Stream Log -->
    <div class="section-title">Live Stream</div>
    <div id="stream-output" style="display:none;margin-bottom:2rem;">
      <div class="stream-log" id="stream-log" style="max-height:500px;"></div>
    </div>
    <div id="stream-placeholder" style="color:var(--text3);font-size:.85rem;padding:2rem;text-align:center;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:2rem;">
      Run a hunt to see the live event stream
    </div>

    <!-- Alpha Result -->
    <div class="alpha-result" id="alpha-result" style="margin-bottom:2rem;">
      <div class="alpha-header">
        <div class="alpha-rec" id="alpha-rec"></div>
        <div class="alpha-conf" id="alpha-conf"></div>
      </div>
      <div class="alpha-signals" id="alpha-signals"></div>
    </div>

    <!-- Signal Breakdown -->
    <div class="panel" id="breakdown-panel" style="display:none;margin-bottom:2rem;">
      <div class="section-title" style="margin-bottom:1rem;">Signal Breakdown</div>
      <div id="breakdown-body"></div>
    </div>

    <!-- Staking Results -->
    <div class="stake-card" id="stake-card">
      <div class="stake-header">
        <span class="stake-title">Staking Results</span>
        <span class="consensus-badge" id="consensus-badge">&mdash;</span>
      </div>
      <div id="stake-rows"></div>
    </div>

    <!-- Competition -->
    <div class="comp-card" id="comp-card">
      <div class="comp-header">Sentiment Agent Competition</div>
      <div class="comp-matchup">
        <div class="comp-agent" id="comp-agent1">
          <div class="comp-agent-name">Sentiment v1</div>
          <div class="comp-agent-ratio" id="comp-ratio1">&mdash;</div>
        </div>
        <div class="comp-vs">VS</div>
        <div class="comp-agent" id="comp-agent2">
          <div class="comp-agent-name">Sentiment v2</div>
          <div class="comp-agent-ratio" id="comp-ratio2">&mdash;</div>
        </div>
      </div>
      <div class="comp-reason" id="comp-reason"></div>
    </div>

    <!-- Payment Log -->
    <div class="tx-feed" id="tx-feed" style="display:none;">
      <div class="tx-header">
        <span class="tx-title">Payment Log</span>
        <span class="badge badge-green" style="font-size:.7rem;"><span class="dot"></span> Base Sepolia</span>
      </div>
      <div id="tx-list"></div>
    </div>
  </main>

  <!-- Status Strip -->
  <div class="status-strip" id="status-strip">
    <div class="status-strip-left">
      <div class="status-indicator loading" id="strip-indicator"></div>
      <span class="status-label loading" id="strip-label">Checking...</span>
    </div>
    <div class="status-dots" id="strip-dots"></div>
    <div class="status-meta">
      <span id="strip-latency">--</span> &middot; <span id="strip-checked">checking</span> &middot; <span class="status-countdown" id="strip-countdown"></span>
    </div>
  </div>

  <footer>
    <span>AlphaClaw Network &middot; Base Sepolia &middot; x402</span>
    <span>SURGE x OpenClaw Hackathon 2026</span>
  </footer>

  <script src="/dashboard.js"></script>
  <script>
    let txLog = [];
    let lastAlpha = null;

    function setTopic(el) { document.getElementById('hunt-topic').value = el.textContent; }

    function addLog(cls, icon, msg) {
      const log = document.getElementById('stream-log');
      const time = new Date().toLocaleTimeString('en', {hour12:false});
      const line = document.createElement('div');
      line.className = `log-line log-${cls}`;
      line.innerHTML = `<span class="log-time">${time}</span><span>${icon} ${msg}</span>`;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function addTx(tx) {
      txLog.unshift(tx);
      if (txLog.length > 20) txLog.pop();
      renderTxList();
    }

    function renderTxList() {
      const feed = document.getElementById('tx-feed');
      feed.style.display = 'block';
      const list = document.getElementById('tx-list');
      list.innerHTML = txLog.map(tx => `
        <div class="tx-item">
          <span class="tx-dir">OUT</span>
          <span class="tx-addr">${tx.service}</span>
          <span class="tx-hash">${shortHash(tx.txHash)}</span>
          <span class="tx-amount">${tx.amount || 'USDC'}</span>
        </div>
      `).join('');
    }

    function showBreakdown(alpha) {
      const b = alpha.breakdown || {};
      const panel = document.getElementById('breakdown-panel');
      if (!Object.keys(b).length) { panel.style.display = 'none'; return; }
      panel.style.display = 'block';
      let html = '';

      if (b.news) {
        html += `<div class="info-card"><div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;color:var(--accent2);">News</div>
          <div class="breakdown-item"><span class="breakdown-key">Top headline</span><span class="breakdown-val">${b.news.topHeadline}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Articles</span><span class="breakdown-val">${b.news.articleCount}</span></div></div>`;
      }
      if (b.sentiment) {
        html += `<div class="info-card"><div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;color:var(--accent2);">Sentiment</div>
          <div class="breakdown-item"><span class="breakdown-key">Label</span><span class="breakdown-val">${b.sentiment.label}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Score</span><span class="breakdown-val">${b.sentiment.score}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Confidence</span><span class="breakdown-val">${b.sentiment.confidence}</span></div></div>`;
      }
      if (b.polymarket) {
        html += `<div class="info-card"><div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;color:var(--accent2);">Polymarket</div>
          <div class="breakdown-item"><span class="breakdown-key">Market</span><span class="breakdown-val">${b.polymarket.market}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Signal</span><span class="breakdown-val">${b.polymarket.signal}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">YES price</span><span class="breakdown-val">${b.polymarket.yesPrice}</span></div></div>`;
      }
      if (b.defi) {
        html += `<div class="info-card"><div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;color:var(--accent2);">DeFi</div>
          <div class="breakdown-item"><span class="breakdown-key">Asset</span><span class="breakdown-val">${b.defi.asset}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Action</span><span class="breakdown-val">${b.defi.action}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">24h change</span><span class="breakdown-val">${b.defi.change24h}</span></div></div>`;
      }
      if (b.whale) {
        html += `<div class="info-card"><div style="font-weight:600;font-size:.85rem;margin-bottom:.5rem;color:var(--accent2);">Whale Activity</div>
          <div class="breakdown-item"><span class="breakdown-key">Signal</span><span class="breakdown-val">${b.whale.signal}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Whale count</span><span class="breakdown-val">${b.whale.whaleCount}</span></div>
          <div class="breakdown-item"><span class="breakdown-key">Total volume</span><span class="breakdown-val">${b.whale.totalVolume}</span></div></div>`;
      }
      document.getElementById('breakdown-body').innerHTML = html;
    }

    function renderStaking(data) {
      if (!data) return;
      const card = document.getElementById('stake-card');
      card.classList.add('visible');
      document.getElementById('consensus-badge').textContent = data.consensus.toUpperCase();
      document.getElementById('consensus-badge').className = `consensus-badge consensus-${data.consensus}`;
      document.getElementById('stake-rows').innerHTML = data.results.map(r => `
        <div class="stake-row">
          <span class="stake-svc">${SERVICE_LABELS[r.service] || r.service}</span>
          <span class="stake-dir ${r.direction}">${r.direction}</span>
          <span class="stake-num">${r.staked.toFixed(0)}</span>
          <span class="stake-num ${r.correct ? 'stake-correct' : 'stake-incorrect'}">${r.correct ? '+' : ''}${(r.returned - r.staked).toFixed(1)}</span>
          <span class="stake-num">${(r.reputationAfter * 100).toFixed(1)}%</span>
        </div>
      `).join('');
    }

    function renderCompetition(data) {
      const card = document.getElementById('comp-card');
      card.classList.add('visible');
      document.getElementById('comp-ratio1').textContent = data.winner === 'sentiment' ? data.winnerRatio : data.loserRatio;
      document.getElementById('comp-ratio2').textContent = data.winner === 'sentiment2' ? data.winnerRatio : data.loserRatio;
      document.getElementById('comp-agent1').className = `comp-agent ${data.winner === 'sentiment' ? 'winner' : 'loser'}`;
      document.getElementById('comp-agent2').className = `comp-agent ${data.winner === 'sentiment2' ? 'winner' : 'loser'}`;
      document.getElementById('comp-reason').textContent = data.reason;
    }

    function runHunt() {
      const topic = document.getElementById('hunt-topic').value.trim();
      if (!topic) { document.getElementById('hunt-topic').focus(); return; }
      const btn = document.getElementById('hunt-btn');
      btn.disabled = true; btn.textContent = 'Hunting\u2026';

      document.getElementById('stream-output').style.display = 'block';
      document.getElementById('stream-placeholder').style.display = 'none';
      document.getElementById('stream-log').innerHTML = '';
      document.getElementById('alpha-result').style.display = 'none';
      document.getElementById('breakdown-panel').style.display = 'none';

      addLog('ok', '\u26a1', `Starting hunt: "${topic}"`);

      const sse = new EventSource(`/stream?topic=${encodeURIComponent(topic)}`);

      sse.addEventListener('start', e => {
        const d = JSON.parse(e.data);
        addLog('ok', '\u26a1', `Coordinator online \u00b7 ${d.services} agents ready`);
      });

      sse.addEventListener('paying', e => {
        const d = JSON.parse(e.data);
        const mult = d.multiplier ? ` (${d.multiplier.toFixed(2)}x)` : '';
        addLog('pay', '\ud83d\udcb3', `Paying ${d.service} \u2026 ${d.amount} USDC${mult}`);
      });

      sse.addEventListener('result', e => {
        const d = JSON.parse(e.data);
        const tx = d.txHash ? ` \u00b7 tx: ${shortHash(d.txHash)}` : (d.paid ? '' : ' (demo)');
        addLog('ok', '\u2705', `${d.service} responded${tx}`);
        if (d.paid && d.txHash) addTx({ service: d.service, txHash: d.txHash, amount: d.amount || 'USDC' });
      });

      sse.addEventListener('alpha', e => {
        const d = JSON.parse(e.data);
        lastAlpha = d;
        addLog('alpha', '\ud83c\udfaf', `Alpha synthesis complete \u00b7 ${d.confidence} confidence`);
        document.getElementById('alpha-rec').textContent = d.recommendation;
        document.getElementById('alpha-conf').textContent = `Confidence: ${d.confidence} (weighted: ${d.weightedConfidence?.toFixed(1) ?? '?'}%)`;
        document.getElementById('alpha-signals').innerHTML = (d.signals||[]).map(s => `<span class="signal-tag">${s}</span>`).join('');
        document.getElementById('alpha-result').style.display = 'block';
        showBreakdown(d);
      });

      sse.addEventListener('staking', e => {
        const d = JSON.parse(e.data);
        addLog('alpha', '\u2696\ufe0f', `Staking: ${d.consensus.toUpperCase()} \u00b7 ${d.totalStaked.toFixed(0)} staked \u2192 ${d.totalReturned.toFixed(0)} returned`);
        renderStaking(d);
      });

      sse.addEventListener('competition', e => {
        const d = JSON.parse(e.data);
        addLog('alpha', '\u2694\ufe0f', `Competition: ${d.winner} wins (${d.winnerRatio} vs ${d.loserRatio})`);
        renderCompetition(d);
      });

      sse.addEventListener('cached', e => {
        const d = JSON.parse(e.data);
        addLog('ok', '\ud83d\udce6', `Report cached: ${d.reportId}`);
      });

      sse.addEventListener('error', e => { try { addLog('err', '\u274c', JSON.parse(e.data).message); } catch {} });
      sse.addEventListener('done', () => { sse.close(); btn.disabled = false; btn.textContent = 'Hunt \u2192'; addLog('ok', '\ud83c\udfc1', 'Hunt complete'); });
      sse.onerror = () => { sse.close(); btn.disabled = false; btn.textContent = 'Hunt \u2192'; };
    }

    // Dynamic pricing
    async function loadPricing() {
      try {
        const r = await fetch('/ping');
        const d = await r.json();
        const dp = d.dynamicPricing || [];
        document.getElementById('pricing-body').innerHTML = dp.map(p => `
          <tr>
            <td style="color:var(--text)">${SERVICE_LABELS[p.service] || p.service}</td>
            <td>${p.basePrice}</td>
            <td style="color:var(--accent2)">${p.effectivePrice}</td>
            <td>${p.multiplier.toFixed(2)}x</td>
            <td>${(p.reputation * 100).toFixed(0)}%</td>
          </tr>
        `).join('') + `<tr style="border-top:2px solid var(--border2)">
          <td style="color:var(--text);font-weight:700">Total</td>
          <td></td><td style="color:var(--green);font-weight:700">${d.totalBuyCost}</td><td></td><td></td></tr>`;
      } catch {}
    }

    document.getElementById('hunt-topic').addEventListener('keydown', e => { if (e.key === 'Enter') runHunt(); });
    loadStatusStrip();
    loadTelegram();
    loadPricing();
  </script>
</body>
</html>
