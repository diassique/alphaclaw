<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlphaClaw â€” Reports</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/dashboard.css" />
</head>
<body>
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>

  <nav>
    <a class="logo" href="/">
      <div class="logo-icon"><img src="/logo.svg" alt="AlphaClaw" /></div>
      <div>AlphaClaw<div class="logo-sub">AI Alpha Marketplace</div></div>
    </a>
    <div class="nav-links">
      <a class="nav-link" href="/">Dashboard</a>
      <a class="nav-link" href="/hunt-page">Hunt</a>
      <a class="nav-link" href="/autopilot-page">Autopilot</a>
      <a class="nav-link" href="/reputation-page">Reputation</a>
      <a class="nav-link" href="/memory-page">Memory</a>
      <a class="nav-link" href="/network-page">Network</a>
      <a class="nav-link" href="/reports-page">Reports</a>
      <a class="nav-link" href="/telegram-page">Telegram</a>
    </div>
    <div class="nav-right">
      <span class="tg-badge tg-off" id="tg-badge" title="Telegram Bot">TG OFF</span>
      <span class="badge badge-green"><span class="dot"></span> LIVE</span>
      <span class="badge badge-purple">Base Sepolia &middot; x402</span>
    </div>
  </nav>

  <main>
    <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
      <div>
        <h1><span>Reports</span> Archive</h1>
        <p><span id="report-count">0</span> cached reports available</p>
      </div>
      <a class="btn btn-primary" href="/hunt-page">Run a Hunt &rarr;</a>
    </div>

    <!-- Filter -->
    <div style="margin-bottom:1.5rem;">
      <input class="hunt-input" id="filter-input" type="text" placeholder="Filter by topic..." style="max-width:400px;" oninput="filterReports()" />
    </div>

    <!-- Reports Grid -->
    <div class="reports-grid" id="reports-grid">
      <div style="color:var(--text3);font-size:.85rem;grid-column:1/-1;padding:2rem;text-align:center;">Loading reports...</div>
    </div>
  </main>

  <!-- Report Modal -->
  <div class="modal-overlay" id="modal" onclick="closeModal(event)">
    <div class="modal" id="modal-content">
      <button class="modal-close" onclick="closeModal()">Close</button>
      <h2 id="modal-title">Alpha Report</h2>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Status Strip -->
  <div class="status-strip" id="status-strip">
    <div class="status-strip-left">
      <div class="status-indicator loading" id="strip-indicator"></div>
      <span class="status-label loading" id="strip-label">Checking...</span>
    </div>
    <div class="status-dots" id="strip-dots"></div>
    <div class="status-meta">
      <span id="strip-latency">--</span> &middot; <span id="strip-checked">checking</span> &middot; <span class="status-countdown" id="strip-countdown"></span>
    </div>
  </div>

  <footer>
    <span>AlphaClaw Network &middot; Base Sepolia &middot; x402</span>
    <span>SURGE x OpenClaw Hackathon 2026</span>
  </footer>

  <script src="/dashboard.js"></script>
  <script>
    let allReports = [];

    function renderReports(reports) {
      const grid = document.getElementById('reports-grid');
      if (!reports.length) {
        grid.innerHTML = '<div style="color:var(--text3);font-size:.85rem;grid-column:1/-1;padding:2rem;text-align:center;">No reports found</div>';
        return;
      }
      grid.innerHTML = reports.map(rep => `
        <div class="report-card" onclick="openReport('${rep.id}')">
          <div class="report-meta">
            <span class="report-id">#${rep.id}</span>
            <span class="report-price">${rep.price}</span>
          </div>
          <div class="report-topic">${rep.topic}</div>
          <div class="report-preview">${rep.preview}</div>
          <div class="report-footer">
            <span class="report-time">${timeAgo(rep.timestamp)}</span>
            <span class="badge badge-purple" style="font-size:.68rem;">Buy via x402</span>
          </div>
        </div>
      `).join('');
    }

    function filterReports() {
      const q = document.getElementById('filter-input').value.toLowerCase();
      const filtered = q ? allReports.filter(r => r.topic.toLowerCase().includes(q) || r.preview.toLowerCase().includes(q)) : allReports;
      renderReports(filtered);
    }

    async function loadReports() {
      try {
        const r = await fetch('/reports');
        const d = await r.json();
        allReports = d.reports || [];
        document.getElementById('report-count').textContent = d.count;
        renderReports(allReports);
      } catch {}
    }

    async function openReport(id) {
      document.getElementById('modal').classList.add('open');
      const body = document.getElementById('modal-body');
      body.innerHTML = '<div style="color:var(--text3);padding:2rem;text-align:center;">Loading\u2026</div>';

      try {
        const r = await fetch(`/report/${id}`);
        const d = await r.json();

        if (r.status === 402) {
          document.getElementById('modal-title').textContent = 'Locked Report';
          body.innerHTML = `<div style="text-align:center;padding:1rem;"><p style="color:var(--text2);margin-bottom:1rem;">This report requires <strong>$0.01 USDC</strong> via x402.</p><button class="btn btn-primary" onclick="copyEndpoint('${id}')">Copy x402 Endpoint</button></div>`;
          return;
        }

        document.getElementById('modal-title').textContent = d.topic || 'Report';
        const a = d.alpha || {};
        const b = a.breakdown || {};

        body.innerHTML = `
          <div class="report-detail-section">
            <div class="report-detail-label">Synthesis</div>
            <div style="font-size:1rem;font-weight:600;margin-bottom:.5rem">${a.recommendation || '\u2014'}</div>
            <div style="font-size:.85rem;color:var(--text2)">Confidence: <strong style="color:var(--accent2)">${a.confidence || '\u2014'}</strong>${a.weightedConfidence ? ` (weighted: ${a.weightedConfidence.toFixed(1)}%)` : ''}</div>
          </div>
          <div class="report-detail-section">
            <div class="report-detail-label">Signals</div>
            <div class="alpha-signals">${(a.signals||[]).map(s=>`<span class="signal-tag">${s}</span>`).join('')||'<span style="color:var(--text3)">No signals</span>'}</div>
          </div>
          ${b.news ? `<div class="report-detail-section"><div class="report-detail-label">News</div><div class="breakdown-item"><span class="breakdown-key">Headline</span><span class="breakdown-val">${b.news.topHeadline}</span></div><div class="breakdown-item"><span class="breakdown-key">Articles</span><span class="breakdown-val">${b.news.articleCount}</span></div></div>` : ''}
          ${b.sentiment ? `<div class="report-detail-section"><div class="report-detail-label">Sentiment</div><div class="breakdown-item"><span class="breakdown-key">Label</span><span class="breakdown-val">${b.sentiment.label}</span></div><div class="breakdown-item"><span class="breakdown-key">Score</span><span class="breakdown-val">${b.sentiment.score}</span></div><div class="breakdown-item"><span class="breakdown-key">Confidence</span><span class="breakdown-val">${b.sentiment.confidence}</span></div></div>` : ''}
          ${b.polymarket ? `<div class="report-detail-section"><div class="report-detail-label">Polymarket</div><div class="breakdown-item"><span class="breakdown-key">Market</span><span class="breakdown-val">${b.polymarket.market}</span></div><div class="breakdown-item"><span class="breakdown-key">Signal</span><span class="breakdown-val">${b.polymarket.signal}</span></div><div class="breakdown-item"><span class="breakdown-key">YES price</span><span class="breakdown-val">${b.polymarket.yesPrice}</span></div></div>` : ''}
          ${b.defi ? `<div class="report-detail-section"><div class="report-detail-label">DeFi</div><div class="breakdown-item"><span class="breakdown-key">Asset</span><span class="breakdown-val">${b.defi.asset}</span></div><div class="breakdown-item"><span class="breakdown-key">Action</span><span class="breakdown-val">${b.defi.action}</span></div><div class="breakdown-item"><span class="breakdown-key">24h change</span><span class="breakdown-val">${b.defi.change24h}</span></div></div>` : ''}
          ${b.whale ? `<div class="report-detail-section"><div class="report-detail-label">Whale Activity</div><div class="breakdown-item"><span class="breakdown-key">Signal</span><span class="breakdown-val">${b.whale.signal}</span></div><div class="breakdown-item"><span class="breakdown-key">Whale count</span><span class="breakdown-val">${b.whale.whaleCount}</span></div><div class="breakdown-item"><span class="breakdown-key">Volume</span><span class="breakdown-val">${b.whale.totalVolume}</span></div></div>` : ''}
          ${d.stakingSummary ? `<div class="report-detail-section"><div class="report-detail-label">Staking Results</div><div class="breakdown-item"><span class="breakdown-key">Consensus</span><span class="breakdown-val">${d.stakingSummary.consensus.toUpperCase()}</span></div><div class="breakdown-item"><span class="breakdown-key">Total Staked</span><span class="breakdown-val">${d.stakingSummary.totalStaked}</span></div><div class="breakdown-item"><span class="breakdown-key">Total Returned</span><span class="breakdown-val" style="color:${d.stakingSummary.totalReturned >= d.stakingSummary.totalStaked ? 'var(--green)' : 'var(--red)'}">${d.stakingSummary.totalReturned}</span></div>${(d.stakingSummary.results||[]).map(r=>`<div class="breakdown-item"><span class="breakdown-key">${r.service}</span><span class="breakdown-val" style="color:${r.correct?'var(--green)':'var(--red)'}">${r.correct?'OK':'MISS'} ${r.direction} \u00b7 ${r.staked}\u2192${r.returned}</span></div>`).join('')}</div>` : ''}
          <div class="report-detail-section"><div class="report-detail-label">Agent Payments</div>${(d.agentPayments?.breakdown||[]).map(p=>`<div class="breakdown-item"><span class="breakdown-key">${p.service}</span><span class="breakdown-val" style="color:${p.paid?'var(--green)':'var(--text3)'}">${p.paid?'Paid':'Demo'} ${p.price}${p.txHash?` \u00b7 ${shortHash(p.txHash)}`:''}</span></div>`).join('')}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding-top:.75rem;border-top:1px solid var(--border);margin-top:1rem;">
            <span style="font-size:.72rem;color:var(--text3);font-family:var(--mono)">Report: ${d.reportId || id} \u00b7 ${d.timestamp || ''}</span>
            <button class="btn-sm btn-secondary" onclick="copyJSON('${id}')">Copy JSON</button>
          </div>
        `;
      } catch(e) {
        body.innerHTML = '<div style="color:var(--red)">Failed to load report</div>';
      }
    }

    function copyEndpoint(id) {
      navigator.clipboard.writeText(`${location.origin}/report/${id}`);
      alert('Endpoint copied!');
    }

    async function copyJSON(id) {
      try {
        const r = await fetch(`/report/${id}`);
        const d = await r.json();
        navigator.clipboard.writeText(JSON.stringify(d, null, 2));
        alert('Report JSON copied to clipboard');
      } catch { alert('Failed to copy'); }
    }

    function closeModal(e) {
      if (!e || e.target === document.getElementById('modal')) {
        document.getElementById('modal').classList.remove('open');
      }
    }

    loadStatusStrip();
    loadTelegram();
    loadReports();
    setInterval(loadReports, 15000);
  </script>
</body>
</html>
